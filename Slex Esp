--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer
local UserInputService = game:GetService("UserInputService")

--// Settings
local ESP_ENABLED = true
local BOX_ENABLED = true
local NAME_ENABLED = true
local DISTANCE_ENABLED = true
local HEALTH_ENABLED = true

local BOX_COLOR = Color3.fromRGB(0,255,0)
local HEALTH_COLOR = Color3.fromRGB(0,255,0)
local TEXT_COLOR = Color3.fromRGB(255,255,255)

local ESP_OBJECTS = {}

--// Functions
local function WorldToScreen(pos)
	local screenPos, onScreen = Camera:WorldToViewportPoint(pos)
	return Vector2.new(screenPos.X, screenPos.Y), onScreen
end

local function CreateESP(player)
	if player == LocalPlayer then return end

	local box = Drawing.new("Square")
	box.Thickness = 1
	box.Filled = false
	box.Color = BOX_COLOR
	box.Visible = false

	local name = Drawing.new("Text")
	name.Size = 13
	name.Center = true
	name.Outline = true
	name.Color = TEXT_COLOR
	name.Visible = false

	local distance = Drawing.new("Text")
	distance.Size = 12
	distance.Center = true
	distance.Outline = true
	distance.Color = TEXT_COLOR
	distance.Visible = false

	local healthbar = Drawing.new("Line")
	healthbar.Thickness = 2
	healthbar.Color = HEALTH_COLOR
	healthbar.Visible = false

	ESP_OBJECTS[player] = {
		Box = box,
		Name = name,
		Distance = distance,
		Health = healthbar
	}
end

local function RemoveESP(player)
	if ESP_OBJECTS[player] then
		for _,v in pairs(ESP_OBJECTS[player]) do
			v:Remove()
		end
		ESP_OBJECTS[player] = nil
	end
end

--// Update Loop
RunService.RenderStepped:Connect(function()
	if not ESP_ENABLED then
		for _,esp in pairs(ESP_OBJECTS) do
			for _,v in pairs(esp) do
				v.Visible = false
			end
		end
		return
	end

	for player,esp in pairs(ESP_OBJECTS) do
		local char = player.Character
		local hum = char and char:FindFirstChildOfClass("Humanoid")
		local hrp = char and char:FindFirstChild("HumanoidRootPart")

		if char and hum and hrp and hum.Health > 0 then
			local pos, onscreen = WorldToScreen(hrp.Position)
			if onscreen then
				local height = (Camera:WorldToViewportPoint(hrp.Position + Vector3.new(0,3,0)).Y -
							   Camera:WorldToViewportPoint(hrp.Position - Vector3.new(0,3,0)).Y)
				local width = height / 2

				-- Box
				if BOX_ENABLED then
					esp.Box.Size = Vector2.new(width, height)
					esp.Box.Position = Vector2.new(pos.X - width/2, pos.Y - height/2)
					esp.Box.Visible = true
				else
					esp.Box.Visible = false
				end

				-- Name
				if NAME_ENABLED then
					esp.Name.Text = player.Name
					esp.Name.Position = Vector2.new(pos.X, pos.Y - height/2 - 14)
					esp.Name.Visible = true
				else
					esp.Name.Visible = false
				end

				-- Distance
				if DISTANCE_ENABLED then
					local dist = math.floor((Camera.CFrame.Position - hrp.Position).Magnitude)
					esp.Distance.Text = dist .. "m"
					esp.Distance.Position = Vector2.new(pos.X, pos.Y + height/2)
					esp.Distance.Visible = true
				else
					esp.Distance.Visible = false
				end

				-- Health
				if HEALTH_ENABLED then
					local hpPercent = hum.Health / hum.MaxHealth
					esp.Health.From = Vector2.new(pos.X - width/2 - 4, pos.Y + height/2)
					esp.Health.To = Vector2.new(
						pos.X - width/2 - 4,
						pos.Y + height/2 - (height * hpPercent)
					)
					esp.Health.Color = Color3.fromRGB(
						255 - (255 * hpPercent),
						255 * hpPercent,
						0
					)
					esp.Health.Visible = true
				else
					esp.Health.Visible = false
				end
			else
				for _,v in pairs(esp) do
					v.Visible = false
				end
			end
		else
			for _,v in pairs(esp) do
				v.Visible = false
			end
		end
	end
end)

--// Player Handling
for _,p in pairs(Players:GetPlayers()) do
	CreateESP(p)
end

Players.PlayerAdded:Connect(CreateESP)
Players.PlayerRemoving:Connect(RemoveESP)

--// Toggle (Insert)
UserInputService.InputBegan:Connect(function(input, gp)
	if gp then return end
	if input.KeyCode == Enum.KeyCode.Insert then
		ESP_ENABLED = not ESP_ENABLED
	end
end)
