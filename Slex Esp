-- Services
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local Camera = workspace.CurrentCamera
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

-- Settings
local features = {
    silentaim = true,
    fov = 500
}

local target = nil

-- Get nearest player to mouse
local function getnearest()
    local nearestMagnitude = math.huge
    local nearestEnemy = nil

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            local char = player.Character
            local humanoid = char:FindFirstChild("Humanoid")
            local hrp = char:FindFirstChild("HumanoidRootPart")
            local head = char:FindFirstChild("Head")

            if humanoid and hrp and head and humanoid.Health > 0 then
                local screenPos, onScreen = Camera:WorldToScreenPoint(hrp.Position)
                if onScreen then
                    -- Wall check
                    local ray = Ray.new(
                        Camera.CFrame.Position,
                        (head.Position - Camera.CFrame.Position).Unit * 500
                    )

                    local ignore = { LocalPlayer.Character }
                    local hit = workspace:FindPartOnRayWithIgnoreList(ray, ignore)

                    if hit and hit:FindFirstAncestorOfClass("Model") then
                        local dist = (
                            Vector2.new(Mouse.X, Mouse.Y) -
                            Vector2.new(screenPos.X, screenPos.Y)
                        ).Magnitude

                        if dist < nearestMagnitude and dist <= features.fov then
                            nearestMagnitude = dist
                            nearestEnemy = player
                        end
                    end
                end
            end
        end
    end

    return nearestEnemy
end

-- Ray hook
local mt = getrawmetatable(game)
setreadonly(mt, false)

local oldNamecall = mt.__namecall
mt.__namecall = newcclosure(function(...)
    local method = getnamecallmethod()
    local args = { ... }

    if string.find(method, "Ray") and target then
        args[2] = Ray.new(
            Camera.CFrame.Position,
            (target +
            Vector3.new(
                0,
                (Camera.CFrame.Position - target).Magnitude / 500,
                0
            ) - Camera.CFrame.Position).Unit * 500
        )
    end

    return oldNamecall(unpack(args))
end)

-- Main loop
RunService:BindToRenderStep("SilentAim", 1, function()
    if UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton1)
        and features.silentaim
        and LocalPlayer.Character
        and LocalPlayer.Character:FindFirstChild("Humanoid")
        and LocalPlayer.Character.Humanoid.Health > 0 then

        local enemy = getnearest()
        if enemy and enemy.Character and enemy.Character:FindFirstChild("Head") then
            target = enemy.Character.Head.Position
        end
    else
        target = nil
    end
end)
