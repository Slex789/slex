if not game:IsLoaded() then game.Loaded:Wait() end

-- Services
local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

-- Settings
local settings = {
    Enabled = true,
    ShowNames = true,
    ShowBox = true,
    ShowSkeleton = true,
    ShowLines = false,

    -- RGB COLOR
    Color = Color3.fromRGB(255, 0, 0),

    Font = 2
}

local ESPCache = {}

-- UI
local gui = Instance.new("ScreenGui", game.CoreGui)
gui.Name = "SlexProjectESP"

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0,200,0,280)
frame.Position = UDim2.new(0.8,0,0.5,-140)
frame.BackgroundColor3 = Color3.fromRGB(40,40,40)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1,0,0,20)
title.BackgroundColor3 = Color3.fromRGB(60,60,60)
title.Text = "Slex Project"
title.TextColor3 = Color3.new(1,1,1)
title.Font = Enum.Font.Gotham
title.TextSize = 12

local function Toggle(text, y, flag)
    local b = Instance.new("TextButton", frame)
    b.Size = UDim2.new(0,160,0,25)
    b.Position = UDim2.new(0,20,0,y)
    b.BackgroundColor3 = Color3.fromRGB(60,60,60)
    b.BorderSizePixel = 0
    b.TextColor3 = Color3.new(1,1,1)
    b.Font = Enum.Font.Gotham
    b.TextSize = 13
    b.Text = text

    b.MouseButton1Click:Connect(function()
        settings[flag] = not settings[flag]
    end)
end

Toggle("Enable ESP", 30, "Enabled")
Toggle("Show Names", 60, "ShowNames")
Toggle("Show Box", 90, "ShowBox")
Toggle("Show Skeleton", 120, "ShowSkeleton")
Toggle("Show Lines", 150, "ShowLines")

-- Skeleton bones
local BonesR15 = {
    {"Head","UpperTorso"},{"UpperTorso","LowerTorso"},
    {"UpperTorso","LeftUpperArm"},{"LeftUpperArm","LeftLowerArm"},{"LeftLowerArm","LeftHand"},
    {"UpperTorso","RightUpperArm"},{"RightUpperArm","RightLowerArm"},{"RightLowerArm","RightHand"},
    {"LowerTorso","LeftUpperLeg"},{"LeftUpperLeg","LeftLowerLeg"},{"LeftLowerLeg","LeftFoot"},
    {"LowerTorso","RightUpperLeg"},{"RightUpperLeg","RightLowerLeg"},{"RightLowerLeg","RightFoot"},
}

local BonesR6 = {
    {"Head","Torso"},
    {"Torso","Left Arm"},{"Torso","Right Arm"},
    {"Torso","Left Leg"},{"Torso","Right Leg"},
}

-- ESP
local function CreateESP(player)
    if ESPCache[player] then return end

    local esp = {
        Name = Drawing.new("Text"),
        Line = Drawing.new("Line"),
        Box = Drawing.new("Square"),
        Skeleton = {},
        Conn = nil
    }

    esp.Name.Center = true
    esp.Name.Outline = true
    esp.Name.Font = settings.Font
    esp.Name.Size = 18

    esp.Line.Thickness = 1
    esp.Box.Thickness = 1
    esp.Box.Filled = false

    ESPCache[player] = esp

    esp.Conn = RunService.RenderStepped:Connect(function()
        if not settings.Enabled then
            esp.Name.Visible = false
            esp.Line.Visible = false
            esp.Box.Visible = false
            for _,l in ipairs(esp.Skeleton) do l.Visible = false end
            return
        end

        local char = player.Character
        if not char then return end

        local hrp = char:FindFirstChild("HumanoidRootPart")
        local head = char:FindFirstChild("Head")
        if not hrp or not head then return end

        local color = settings.Color

        local headPos, on1 = Camera:WorldToViewportPoint(head.Position)
        local rootPos, on2 = Camera:WorldToViewportPoint(hrp.Position)

        -- Name
        esp.Name.Visible = settings.ShowNames and on1
        if esp.Name.Visible then
            esp.Name.Text = player.Name
            esp.Name.Position = Vector2.new(headPos.X, headPos.Y - 15)
            esp.Name.Color = color
        end

        -- Line
        esp.Line.Visible = settings.ShowLines and on2
        if esp.Line.Visible then
            esp.Line.From = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y)
            esp.Line.To = Vector2.new(rootPos.X, rootPos.Y)
            esp.Line.Color = color
        end

        -- Box
        esp.Box.Visible = settings.ShowBox and on1 and on2
        if esp.Box.Visible then
            local h = math.abs(headPos.Y - rootPos.Y) * 1.6
            local w = h / 2
            esp.Box.Size = Vector2.new(w, h)
            esp.Box.Position = Vector2.new(rootPos.X - w/2, headPos.Y - h*0.15)
            esp.Box.Color = color
        end

        -- Skeleton (R6 / R15)
        for _,l in ipairs(esp.Skeleton) do l:Remove() end
        esp.Skeleton = {}

        local boneList = char:FindFirstChild("UpperTorso") and BonesR15 or BonesR6

        if settings.ShowSkeleton then
            for _,b in ipairs(boneList) do
                local p1, p2 = char:FindFirstChild(b[1]), char:FindFirstChild(b[2])
                if p1 and p2 then
                    local a,v1 = Camera:WorldToViewportPoint(p1.Position)
                    local c,v2 = Camera:WorldToViewportPoint(p2.Position)
                    if v1 and v2 then
                        local l = Drawing.new("Line")
                        l.From = Vector2.new(a.X,a.Y)
                        l.To = Vector2.new(c.X,c.Y)
                        l.Color = color
                        l.Thickness = 1
                        l.Visible = true
                        table.insert(esp.Skeleton, l)
                    end
                end
            end
        end
    end)
end

for _,p in ipairs(Players:GetPlayers()) do
    if p ~= Player then CreateESP(p) end
end

Players.PlayerAdded:Connect(function(p)
    p.CharacterAdded:Connect(function()
        CreateESP(p)
    end)
end)

Players.PlayerRemoving:Connect(function(p)
    local e = ESPCache[p]
    if e then
        e.Conn:Disconnect()
        e.Name:Remove()
        e.Line:Remove()
        e.Box:Remove()
        for _,l in ipairs(e.Skeleton) do l:Remove() end
        ESPCache[p] = nil
    end
end)

-- INSERT toggle
UserInputService.InputBegan:Connect(function(i,gp)
    if not gp and i.KeyCode == Enum.KeyCode.Insert then
        frame.Visible = not frame.Visible
    end
end)
