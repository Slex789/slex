if not game:IsLoaded() then
    game.Loaded:Wait()
end

-- Services
local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

-- Settings
local settings = {
    Enabled = true,
    ShowNames = true,
    ShowOutline = true,
    ShowFill = false,
    ShowLines = false,
    TeamColor = false,
    Font = 2,

    SilentAim = false,
    SilentFOV = 150
}

-- ESP Storage
local ESPCache = {}

-- UI
local screenGui = Instance.new("ScreenGui", game.CoreGui)
screenGui.Name = "SlexProject"

local frame = Instance.new("Frame", screenGui)
frame.Size = UDim2.new(0, 200, 0, 300)
frame.Position = UDim2.new(0.8, 0, 0.5, -140)
frame.BackgroundColor3 = Color3.fromRGB(40,40,40)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true

local dragHandle = Instance.new("TextLabel", frame)
dragHandle.Size = UDim2.new(1,0,0,20)
dragHandle.BackgroundColor3 = Color3.fromRGB(60,60,60)
dragHandle.Text = "Slex Project - ESP"
dragHandle.TextColor3 = Color3.new(1,1,1)
dragHandle.Font = Enum.Font.Gotham
dragHandle.TextSize = 12

local instructions = Instance.new("TextLabel", frame)
instructions.Size = UDim2.new(1,-10,0,30)
instructions.Position = UDim2.new(0,5,1,-35)
instructions.BackgroundTransparency = 1
instructions.Text = "Insert ile aç/kapat\nÜstten sürükle"
instructions.TextColor3 = Color3.new(0.8,0.8,0.8)
instructions.Font = Enum.Font.Gotham
instructions.TextSize = 12
instructions.TextWrapped = true

local function CreateToggle(text, ypos, flag)
    local t = Instance.new("Frame", frame)
    t.Size = UDim2.new(1,0,0,30)
    t.Position = UDim2.new(0,0,0,ypos)
    t.BackgroundTransparency = 1

    local b = Instance.new("TextButton", t)
    b.Size = UDim2.new(0,120,0,25)
    b.Position = UDim2.new(0,10,0,2)
    b.Text = text
    b.Font = Enum.Font.Gotham
    b.TextSize = 14
    b.TextColor3 = Color3.new(1,1,1)
    b.BackgroundColor3 = Color3.fromRGB(60,60,60)
    b.BorderSizePixel = 0

    local s = Instance.new("Frame", t)
    s.Size = UDim2.new(0,20,0,20)
    s.Position = UDim2.new(1,-30,0,5)
    s.BorderSizePixel = 0

    local function refresh()
        s.BackgroundColor3 = settings[flag] and Color3.new(0,1,0) or Color3.new(0.2,0.2,0.2)
    end

    b.MouseButton1Click:Connect(function()
        settings[flag] = not settings[flag]
        refresh()
    end)

    refresh()
end

CreateToggle("Enable ESP",25,"Enabled")
CreateToggle("Show Names",55,"ShowNames")
CreateToggle("Show Outline",85,"ShowOutline")
CreateToggle("Show Fill",115,"ShowFill")
CreateToggle("Show Lines",145,"ShowLines")
CreateToggle("Team Colors",175,"TeamColor")
CreateToggle("Silent Aim",205,"SilentAim")

-- FOV Slider
local sliderFrame = Instance.new("Frame", frame)
sliderFrame.Size = UDim2.new(1,-20,0,40)
sliderFrame.Position = UDim2.new(0,10,0,235)
sliderFrame.BackgroundTransparency = 1

local bar = Instance.new("Frame", sliderFrame)
bar.Size = UDim2.new(1,0,0,6)
bar.Position = UDim2.new(0,0,0,18)
bar.BackgroundColor3 = Color3.fromRGB(70,70,70)
bar.BorderSizePixel = 0

local knob = Instance.new("Frame", bar)
knob.Size = UDim2.new(0,10,0,16)
knob.BackgroundColor3 = Color3.new(1,1,1)
knob.BorderSizePixel = 0

local drag = false
knob.InputBegan:Connect(function(i)
    if i.UserInputType == Enum.UserInputType.MouseButton1 then drag = true end
end)
UserInputService.InputEnded:Connect(function(i)
    if i.UserInputType == Enum.UserInputType.MouseButton1 then drag = false end
end)
UserInputService.InputChanged:Connect(function(i)
    if drag and i.UserInputType == Enum.UserInputType.MouseMovement then
        local scale = math.clamp((i.Position.X-bar.AbsolutePosition.X)/bar.AbsoluteSize.X,0,1)
        knob.Position = UDim2.new(scale,-5,-0.5,0)
        settings.SilentFOV = math.floor(scale*400)
    end
end)

-- FOV Circle
local circle = Drawing.new("Circle")
circle.Thickness = 1
circle.Filled = false
circle.Color = Color3.new(1,1,1)

RunService.RenderStepped:Connect(function()
    circle.Position = Vector2.new(Camera.ViewportSize.X/2,Camera.ViewportSize.Y/2)
    circle.Radius = settings.SilentFOV
    circle.Visible = settings.SilentAim
end)

-- Silent Aim Logic
local function GetTarget()
    local best, dist = nil, math.huge
    for _,plr in ipairs(Players:GetPlayers()) do
        if plr~=Player and plr.Character then
            local h = plr.Character:FindFirstChild("Head")
            local hum = plr.Character:FindFirstChild("Humanoid")
            if h and hum and hum.Health>0 then
                local p,on = Camera:WorldToScreenPoint(h.Position)
                if on then
                    local m = (Vector2.new(p.X,p.Y)-circle.Position).Magnitude
                    if m<dist and m<=settings.SilentFOV then
                        dist=m
                        best=h.Position
                    end
                end
            end
        end
    end
    return best
end

local mt = getrawmetatable(game)
setreadonly(mt,false)
local old = mt.__namecall
mt.__namecall = newcclosure(function(self,...)
    local method = getnamecallmethod()
    local args = {...}
    if method=="FindPartOnRayWithIgnoreList" and settings.SilentAim then
        local t = GetTarget()
        if t then
            args[1]=Ray.new(Camera.CFrame.Position,(t-Camera.CFrame.Position).Unit*1000)
        end
    end
    return old(self,unpack(args))
end)

-- Insert toggle
UserInputService.InputBegan:Connect(function(i,g)
    if not g and i.KeyCode==Enum.KeyCode.Insert then
        frame.Visible = not frame.Visible
    end
end)
